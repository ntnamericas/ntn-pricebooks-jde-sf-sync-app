%dw 2.0
output text/plain
--- 
"WITH BPLITM_F4106 AS (
---Get LITM from 4106 where BPMCU=1801
    Select TRIM(X1.BPLITM) AS BPLITM, TRIM(X1.BPMCU) AS BPMCU, TRIM(X1.BPUPMJ) AS BPUPMJ, TRIM(X1.BPTDAY) AS BPTDAY, TRIM(X1.BPUPRC) AS BPUPRC, TRIM(X1.BPCRCD) AS BPCRCD, TRIM(X1.BPEFTJ) AS BPEFTJ, TRIM(X1.BPEXDJ) AS BPEXDJ
    FROM PRODDTA.F4106 X1
    WHERE  TRIM(X1.BPMCU)='1801' and (( X1.BPEXDJ >= $(vars.previousPbJobRun.date) 
    and X1.BPUPMJ >= $(vars.previousPbJobRun.date) AND X1.BPTDAY > $(vars.previousPbJobRun.time)) or X1.BPEFTJ >= $(vars.previousPbJobRun.date))
),

IBPRP1_IBSRP4_BPLITM AS (
---Query PRP1 and SRP4 where LITM = (BPLITM) and IBMCU=BPMCU.Hold the variables PRP1 and SRP4
    SELECT DISTINCT
    TRIM(TT1.IBPRP1) AS IBPRP1,
    TRIM(TT1.IBSRP4) AS IBSRP4,
    TRIM(TT1.IBLITM) AS IBLITM,
    TRIM(TT1.IBMCU) AS IBMCU
    FROM PRODDTA.F4102 TT1
    INNER JOIN BPLITM_F4106 TT2 ON TRIM(TT1.IBLITM)=TRIM(TT2.BPLITM) AND TRIM(TT1.IBMCU)=TRIM(TT2.BPMCU)
),

IMDRAW_IMSRTX_BPLITM AS (
---Query IMDRAW and IMSRTX where LITM = (COLITM) and IBMCU=1801.Hold the variables IMDRAW and IMSRTX
    SELECT TRIM(TT3.IMDRAW) AS IMDRAW, TRIM(TT3.IMSRTX) AS IMSRTX, TRIM(TT3.IMLITM) AS IMLITM
    FROM PRODDTA.F4101 TT3
    INNER JOIN BPLITM_F4106 TT2 ON TRIM(TT3.IMLITM)=TRIM(TT2.BPLITM)
)

SELECT
T1.IBITM,
T1.IBLITM,
T1.IBAITM,
T1.IBMCU,
T2.IMLITM,
T3.IMDRAW,
T3.IMSRTX,
T4.BPUPRC,
T4.BPCRCD,
T4.BPEFTJ,
T4.BPEXDJ,
T4.BPMCU,
T5.IBPRP1,
T5.IBSRP4


FROM PRODDTA.F4102 T1
INNER JOIN PRODDTA.F4101 T2 ON
    TRIM(T1.IBLITM)=TRIM(T2.IMLITM)
    AND TRIM(T1.IBMCU)='1801'
INNER JOIN IMDRAW_IMSRTX_BPLITM T3 ON
     TRIM(T3.IMLITM)=TRIM(T2.IMLITM)
INNER JOIN BPLITM_F4106 T4 ON
    TRIM(T4.BPLITM)=TRIM(T1.IBLITM)
    AND TRIM(T1.IBMCU)=trim(T4.BPMCU)
INNER JOIN IBPRP1_IBSRP4_BPLITM T5 ON
    TRIM(T5.IBLITM)=TRIM(T1.IBLITM)
    AND TRIM(T5.IBMCU)=trim(T4.BPMCU)
WHERE TRIM(T1.IBMCU)='1801' AND  (( T4.BPEXDJ >= $(vars.previousPbJobRun.date) and T4.BPUPMJ = $(vars.previousPbJobRun.date)
    AND T4.BPTDAY >= $(vars.previousPbJobRun.time)) )
    --AND BPLITM = '6004U[T100]'
ORDER BY T4.BPEFTJ DESC"